---
- name: Deploy application and reverse-proxy with nginx
  hosts: web
  become: true
  gather_facts: true

  vars:
    app_base: /opt
    app_dir: "{{ app_base }}/{{ app_name }}"
    # Defaults (override with -e)
    app_repo: "https://github.com/<your-username>/<your-app-repo>.git"
    app_name: "myapp"
    app_lang: "node"        # node or python
    app_port: 3000
    server_name: "myapp.local"
    venv_path: "{{ app_dir }}/venv"

  tasks:
    - name: Ensure required packages (git, build tools, nginx)
      package:
        name:
          - git
          - nginx
        state: present
      tags: packages

    - name: Additional packages for Node (Debian/RedHat)
      package:
        name:
          - nodejs
          - npm
      when: app_lang == 'node'
      tags: packages

    - name: Additional packages for Python (Debian/RedHat)
      package:
        name:
          - python3
          - python3-venv
          - python3-pip
      when: app_lang == 'python'
      tags: packages

    - name: Clone application repository
      git:
        repo: "{{ app_repo }}"
        dest: "{{ app_dir }}"
        version: HEAD
        force: yes
      register: git_clone
      tags: deploy

    - name: Install Node dependencies (npm install)
      shell: |
        npm install --production
      args:
        chdir: "{{ app_dir }}"
      when: app_lang == 'node'
      register: npm_install
      tags: deploy

    - name: Create Python venv
      command: python3 -m venv "{{ venv_path }}"
      args:
        creates: "{{ venv_path }}/bin/activate"
      when: app_lang == 'python'
      tags: deploy

    - name: Install Python dependencies (pip)
      pip:
        requirements: "{{ app_dir }}/requirements.txt"
        virtualenv: "{{ venv_path }}"
      when: app_lang == 'python'
      tags: deploy

    - name: Create systemd service file for the app
      template:
        src: app.service.j2
        dest: "/etc/systemd/system/{{ app_name }}.service"
        owner: root
        group: root
        mode: "0644"
        backup: yes
      notify: 
        - daemon-reload
        - restart app
      tags: service

    - name: Ensure nginx log dir exists
      file:
        path: /var/log/nginx
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Deploy nginx reverse proxy config (validate)
      template:
        src: nginx-app.conf.j2
        dest: "/etc/nginx/conf.d/{{ app_name }}.conf"
        owner: root
        group: root
        mode: "0644"
        backup: yes
        validate: "nginx -t -c %s"
      notify:
        - restart nginx
      tags: nginx

  handlers:
    - name: daemon-reload
      command: systemctl daemon-reload
      listen: daemon-reload

    - name: restart app
      service:
        name: "{{ app_name }}"
        state: restarted
        enabled: yes

    - name: restart nginx
      service:
        name: nginx
        state: restarted
        enabled: yes

